<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AES-256-GCM</title>
  <style>
    :root{--bg0:#030305;--bg2:#0b0e14;--fg:#f3f4f7;--line:rgba(255,255,255,.10);--shadow:rgba(0,0,0,.78);--r:12px}
    *{box-sizing:border-box}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;overflow:hidden;background:radial-gradient(1200px 900px at 18% 10%, rgba(120,170,255,.09), transparent 62%),radial-gradient(900px 700px at 86% 18%, rgba(140,120,255,.06), transparent 60%),radial-gradient(900px 700px at 50% 92%, rgba(110,220,255,.05), transparent 64%),linear-gradient(180deg,var(--bg0),var(--bg2))}
    .sky{position:fixed;inset:0;pointer-events:none;z-index:0;opacity:.9;background:radial-gradient(1000px 700px at 25% 20%, rgba(255,255,255,.05), transparent 65%),radial-gradient(900px 680px at 78% 30%, rgba(255,255,255,.03), transparent 65%),radial-gradient(800px 650px at 55% 85%, rgba(255,255,255,.025), transparent 70%)}
    .sky::before{content:"";position:absolute;inset:0;opacity:.72;background-image:radial-gradient(1px 1px at 8% 12%, rgba(255,255,255,.95), transparent 60%),radial-gradient(1px 1px at 16% 28%, rgba(255,255,255,.70), transparent 60%),radial-gradient(1px 1px at 22% 76%, rgba(255,255,255,.75), transparent 60%),radial-gradient(1px 1px at 31% 44%, rgba(255,255,255,.65), transparent 60%),radial-gradient(1px 1px at 38% 18%, rgba(255,255,255,.60), transparent 60%),radial-gradient(1px 1px at 44% 62%, rgba(255,255,255,.80), transparent 60%),radial-gradient(1px 1px at 52% 26%, rgba(255,255,255,.70), transparent 60%),radial-gradient(1px 1px at 58% 78%, rgba(255,255,255,.65), transparent 60%),radial-gradient(1px 1px at 64% 48%, rgba(255,255,255,.62), transparent 60%),radial-gradient(1px 1px at 71% 22%, rgba(255,255,255,.60), transparent 60%),radial-gradient(1px 1px at 78% 66%, rgba(255,255,255,.78), transparent 60%),radial-gradient(1px 1px at 86% 38%, rgba(255,255,255,.62), transparent 60%),radial-gradient(1px 1px at 92% 18%, rgba(255,255,255,.58), transparent 60%),radial-gradient(1px 1px at 94% 74%, rgba(255,255,255,.66), transparent 60%)}
    .wrap{position:relative;z-index:2;width:min(980px,92vw);padding:20px}
    .box{width:100%;border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.10);box-shadow:0 26px 70px rgba(0,0,0,.62), inset 0 1px 0 rgba(255,255,255,.055);backdrop-filter:blur(10px);overflow:hidden;position:relative}
    .inner{position:relative;padding:20px}
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
    h1{margin:0;font-size:16px;letter-spacing:.55px;opacity:.95;text-transform:uppercase}
    .right{display:flex;gap:10px;align-items:center}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    .two{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%}
    .two>button{width:100%}
    input,textarea,button,label{border-radius:var(--r);border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.30);color:var(--fg);padding:13px 14px;font-size:14px;outline:none;transition:transform .14s ease,border-color .18s ease,background .18s ease,box-shadow .18s ease,filter .18s ease}
    textarea{width:100%;min-height:160px;resize:vertical;line-height:1.35}
    input,textarea{flex:1;min-width:240px}
    input::placeholder,textarea::placeholder{color:rgba(243,244,247,.42)}
    input:focus,textarea:focus{border-color:rgba(200,210,255,.26);box-shadow:0 0 0 3px rgba(180,190,255,.09)}
    button,label{cursor:pointer;user-select:none;display:inline-flex;align-items:center;justify-content:center;gap:8px}
    button:hover,label:hover{border-color:rgba(230,235,255,.22);box-shadow:0 12px 26px rgba(0,0,0,.40),0 0 0 3px rgba(200,210,255,.06);transform:translateY(-1px)}
    button:active,label:active{transform:translateY(1px) scale(.99)}
    .pillbtn{padding:9px 12px;border-radius:999px;font-size:12px;white-space:nowrap;background:linear-gradient(90deg, rgba(255,255,255,.07), rgba(255,255,255,.03));border-color:rgba(255,255,255,.16);box-shadow:inset 0 1px 0 rgba(255,255,255,.08)}
    .btn-primary{border-color:rgba(210,220,255,.18);background:linear-gradient(90deg, rgba(255,255,255,.08), rgba(255,255,255,.04));box-shadow:inset 0 1px 0 rgba(255,255,255,.10)}
    .mini{flex:0;min-width:190px}
    .pwwrap{display:flex;gap:12px;flex:1;min-width:260px}
    .pwwrap input{flex:1;min-width:0}
    .pwbtn{flex:0;min-width:130px}
    .filewrap{display:flex;gap:12px;width:100%;align-items:center;flex-wrap:wrap}
    .filebtn{flex:0 0 auto;min-width:160px}
    .filemeta{flex:1 1 auto;min-width:240px;padding:13px 14px;border-radius:var(--r);border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.22);color:rgba(243,244,247,.78)}
    .mono{font-variant-ligatures:none;font-feature-settings:"liga" 0;letter-spacing:.15px;word-break:break-word}
    .toast{position:fixed;left:50%;bottom:28px;transform:translateX(-50%);background:rgba(0,0,0,.74);border:1px solid rgba(255,255,255,.18);padding:10px 14px;border-radius:12px;font-size:13px;opacity:0;pointer-events:none;transition:opacity .18s ease,transform .18s ease;box-shadow:0 12px 26px var(--shadow);z-index:30}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}
    .disabled{opacity:.45;pointer-events:none;filter:saturate(.75)}
    @media (max-width:420px){input,textarea{min-width:0}.mini{min-width:0;flex:1}.pwbtn{min-width:110px}.pwwrap{min-width:0}.filebtn{min-width:140px}}
  </style>
</head>
<body>
  <div class="sky" aria-hidden="true"></div>

  <div class="wrap">
    <div class="box">
      <div class="inner">
        <div class="top">
          <h1>AES-256-GCM</h1>
          <div class="right">
            <button id="btnSafe" class="pillbtn">BẢO MẬT : TẮT</button>
          </div>
        </div>

        <div class="row">
          <input id="plain" placeholder="Văn bản gốc" value="" autocomplete="off" />
          <input id="iters" class="mini" type="number" value="100000" min="100000" step="100000" inputmode="numeric" />
        </div>

        <div class="row">
          <div class="pwwrap">
            <input id="pass" type="password" placeholder="Mật khẩu" autocomplete="new-password" />
            <button id="btnTogglePass" class="pwbtn">HIỆN</button>
          </div>
        </div>

        <div class="row two">
          <button id="btnEncText" class="btn-primary">MÃ HOÁ VĂN BẢN</button>
          <button id="btnDecAny">GIẢI MÃ</button>
        </div>

        <div class="row">
          <div class="filewrap">
            <input id="file" type="file" hidden />
            <label for="file" class="filebtn">CHỌN FILE</label>
            <div id="filemeta" class="filemeta mono">Chưa chọn file</div>
          </div>
        </div>

        <div class="row">
          <button id="btnEncFile" class="btn-primary">MÃ HOÁ FILE → TOKEN</button>
          <button id="btnDownload" class="pillbtn">TẢI FILE (SAU GIẢI MÃ)</button>
        </div>

        <div class="row">
          <textarea id="token" class="mono" spellcheck="false" placeholder="Token mã hoá (v3... hoặc v3f...)"></textarea>
        </div>

        <div class="row two">
          <button id="btnCopy">SAO CHÉP</button>
          <button id="btnClear">XOÁ</button>
        </div>

        <div class="row">
          <input id="out" placeholder="Kết quả (văn bản)" autocomplete="off" />
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">OK</div>

<script>
  const $ = (id) => document.getElementById(id);

  const enc = new TextEncoder();
  const dec = new TextDecoder();

  const u8ToB64 = (u8) => {
    const CHUNK = 0x8000;
    let s = "";
    for (let i = 0; i < u8.length; i += CHUNK) {
      s += String.fromCharCode.apply(null, u8.subarray(i, i + CHUNK));
    }
    return btoa(s);
  };

  const b64ToU8 = (b64) => {
    const bin = atob(b64);
    const u8 = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) u8[i] = bin.charCodeAt(i);
    return u8;
  };

  const b64url = (u8) =>
    u8ToB64(u8).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

  const b64urlToU8 = (s) => {
    s = (s || "").replace(/-/g,'+').replace(/_/g,'/');
    s += '='.repeat((4 - (s.length % 4)) % 4);
    return b64ToU8(s);
  };

  const strToB64url = (s) => b64url(enc.encode(s));
  const b64urlToStr = (s) => dec.decode(b64urlToU8(s));

  const getIters = () => {
    const n = parseInt($("iters").value || "100000", 10);
    return Number.isFinite(n) ? Math.max(100000, n) : 100000;
  };

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 900);
  }

  let SAFE_MODE = false;
  const disableInSafeMode = ["plain","btnTogglePass","out"];

  function setDisabled(id, on){
    const el = $(id);
    if (!el) return;
    el.disabled = !!on;
    if (on) el.classList.add("disabled");
    else el.classList.remove("disabled");
  }

  function applySafeMode(){
    $("btnSafe").textContent = `BẢO MẬT : ${SAFE_MODE ? "BẬT" : "TẮT"}`;
    if (SAFE_MODE) {
      $("plain").value = "";
      $("out").value = "";
      $("pass").value = "";
      $("pass").type = "password";
      $("btnTogglePass").textContent = "HIỆN";
      disableInSafeMode.forEach(id => setDisabled(id, true));
      toast("Đã bật bảo mật");
    } else {
      disableInSafeMode.forEach(id => setDisabled(id, false));
      toast("Đã tắt bảo mật");
    }
  }

  async function deriveAesKeyFromPass(pass, saltU8, iters) {
    const passKey = await crypto.subtle.importKey(
      "raw",
      enc.encode(pass),
      { name: "PBKDF2" },
      false,
      ["deriveKey"]
    );

    return crypto.subtle.deriveKey(
      { name: "PBKDF2", salt: saltU8, iterations: iters, hash: "SHA-256" },
      passKey,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"]
    );
  }

  function clearSensitiveAfterUse(){
    if (SAFE_MODE) $("pass").value = "";
    if (SAFE_MODE) $("plain").value = "";
  }

  async function encryptText() {
    try {
      const plain = ($("plain").value || "").trim();
      const pass = $("pass").value;

      if (!plain) throw new Error("Bạn chưa nhập văn bản gốc.");
      if (!pass || pass.length < 10) throw new Error("Mật khẩu quá yếu.");

      const iters = getIters();
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const nonce = crypto.getRandomValues(new Uint8Array(12));

      const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

      const ctAll = new Uint8Array(await crypto.subtle.encrypt(
        { name: "AES-GCM", iv: nonce },
        aesKey,
        enc.encode(plain)
      ));

      const ciphertext = ctAll.slice(0, ctAll.length - 16);
      const tag = ctAll.slice(ctAll.length - 16);

      $("token").value = `v3.${iters}.${b64url(salt)}.${b64url(nonce)}.${b64url(ciphertext)}.${b64url(tag)}`;

      clearSensitiveAfterUse();
      toast("Đã mã hoá văn bản");
    } catch (e) {
      toast("Có lỗi");
      if (!SAFE_MODE) $("out").value = "Mã hoá thất bại: " + (e?.message || e);
    }
  }

  let SELECTED_FILE = null;
  let LAST_DECRYPTED_FILE = null;

  $("file").addEventListener("change", () => {
    const f = $("file").files && $("file").files[0];
    SELECTED_FILE = f || null;
    if (!SELECTED_FILE) {
      $("filemeta").textContent = "Chưa chọn file";
      return;
    }
    const kb = (SELECTED_FILE.size / 1024);
    const s = kb < 1024 ? `${kb.toFixed(1)} KB` : `${(kb/1024).toFixed(2)} MB`;
    $("filemeta").textContent = `${SELECTED_FILE.name} • ${s} • ${SELECTED_FILE.type || "application/octet-stream"}`;
  });

  async function encryptFile() {
    try {
      if (!SELECTED_FILE) throw new Error("Bạn chưa chọn file.");
      const pass = $("pass").value;
      if (!pass || pass.length < 10) throw new Error("Mật khẩu quá yếu.");

      const iters = getIters();
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const nonce = crypto.getRandomValues(new Uint8Array(12));

      const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

      const buf = await SELECTED_FILE.arrayBuffer();
      const data = new Uint8Array(buf);

      const ctAll = new Uint8Array(await crypto.subtle.encrypt(
        { name:"AES-GCM", iv: nonce },
        aesKey,
        data
      ));

      const ciphertext = ctAll.slice(0, ctAll.length - 16);
      const tag = ctAll.slice(ctAll.length - 16);

      const nameB64 = strToB64url(SELECTED_FILE.name);
      const mimeB64 = strToB64url(SELECTED_FILE.type || "application/octet-stream");

      $("token").value =
        `v3f.${iters}.${b64url(salt)}.${b64url(nonce)}.${nameB64}.${mimeB64}.${b64url(ciphertext)}.${b64url(tag)}`;

      clearSensitiveAfterUse();
      toast("Đã mã hoá file");
    } catch (e) {
      toast("Có lỗi");
      if (!SAFE_MODE) $("out").value = "Mã hoá file thất bại: " + (e?.message || e);
    }
  }

  async function decryptAny() {
    try {
      const pass = ($("pass").value || "").trim();
      const token = ($("token").value || "").trim();

      if (!pass) throw new Error("Bạn chưa nhập mật khẩu.");
      if (!token) throw new Error("Bạn chưa dán token.");

      const parts = token.split(".");
      const ver = parts[0];

      if (ver === "v3") {
        if (parts.length !== 6) throw new Error("Token v3 không đúng định dạng.");

        const iters = parseInt(parts[1], 10);
        if (!Number.isFinite(iters) || iters < 100000) throw new Error("Iterations không hợp lệ.");

        const salt = b64urlToU8(parts[2]);
        const nonce = b64urlToU8(parts[3]);
        const ciphertext = b64urlToU8(parts[4]);
        const tag = b64urlToU8(parts[5]);

        const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

        const ctAll = new Uint8Array(ciphertext.length + tag.length);
        ctAll.set(ciphertext, 0);
        ctAll.set(tag, ciphertext.length);

        const pt = new Uint8Array(await crypto.subtle.decrypt(
          { name:"AES-GCM", iv: nonce },
          aesKey,
          ctAll
        ));

        const text = dec.decode(pt);
        if (SAFE_MODE) { $("out").value = ""; alert(text); }
        else $("out").value = text;

        LAST_DECRYPTED_FILE = null;
        clearSensitiveAfterUse();
        toast("Đã giải mã văn bản");
        return;
      }

      if (ver === "v3f") {
        if (parts.length !== 8) throw new Error("Token v3f không đúng định dạng.");

        const iters = parseInt(parts[1], 10);
        if (!Number.isFinite(iters) || iters < 100000) throw new Error("Iterations không hợp lệ.");

        const salt = b64urlToU8(parts[2]);
        const nonce = b64urlToU8(parts[3]);
        const fileName = b64urlToStr(parts[4]);
        const mime = b64urlToStr(parts[5]);
        const ciphertext = b64urlToU8(parts[6]);
        const tag = b64urlToU8(parts[7]);

        const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

        const ctAll = new Uint8Array(ciphertext.length + tag.length);
        ctAll.set(ciphertext, 0);
        ctAll.set(tag, ciphertext.length);

        const pt = new Uint8Array(await crypto.subtle.decrypt(
          { name:"AES-GCM", iv: nonce },
          aesKey,
          ctAll
        ));

        LAST_DECRYPTED_FILE = { name: fileName || "file.bin", mime: mime || "application/octet-stream", bytes: pt };
        if (!SAFE_MODE) $("out").value = `Đã giải mã file: ${LAST_DECRYPTED_FILE.name} (${LAST_DECRYPTED_FILE.bytes.length} bytes)`;
        else { $("out").value = ""; alert(`Đã giải mã file: ${LAST_DECRYPTED_FILE.name}`); }

        clearSensitiveAfterUse();
        toast("Đã giải mã file");
        return;
      }

      throw new Error("Token không hỗ trợ (chỉ v3 hoặc v3f).");
    } catch (e) {
      toast("Có lỗi");
      if (!SAFE_MODE) $("out").value = "Giải mã thất bại: " + (e?.message || e);
      LAST_DECRYPTED_FILE = null;
    }
  }

  function downloadDecryptedFile(){
    if (!LAST_DECRYPTED_FILE) return toast("Chưa có file để tải");
    const blob = new Blob([LAST_DECRYPTED_FILE.bytes], { type: LAST_DECRYPTED_FILE.mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = LAST_DECRYPTED_FILE.name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
    toast("Đang tải file");
  }

  async function copyToken(){
    const token = ($("token").value || "").trim();
    if (!token) return toast("Chưa có token");
    try{
      await navigator.clipboard.writeText(token);
      toast("Đã sao chép");
    }catch{
      $("token").focus();
      $("token").select();
      document.execCommand("copy");
      toast("Đã sao chép");
    }
  }

  function clearAll(){
    if (SAFE_MODE) $("plain").value = "";
    $("token").value = "";
    $("out").value = "";
    SELECTED_FILE = null;
    $("file").value = "";
    $("filemeta").textContent = "Chưa chọn file";
    LAST_DECRYPTED_FILE = null;
    if (SAFE_MODE) $("pass").value = "";
    toast("Đã xoá");
  }

  function togglePass(){
    if (SAFE_MODE) return;
    const p = $("pass");
    const isPw = p.type === "password";
    p.type = isPw ? "text" : "password";
    $("btnTogglePass").textContent = isPw ? "ẨN" : "HIỆN";
  }

  $("btnEncText").addEventListener("click", encryptText);
  $("btnEncFile").addEventListener("click", encryptFile);
  $("btnDecAny").addEventListener("click", decryptAny);
  $("btnDownload").addEventListener("click", downloadDecryptedFile);
  $("btnCopy").addEventListener("click", copyToken);
  $("btnClear").addEventListener("click", clearAll);
  $("btnTogglePass").addEventListener("click", togglePass);

  $("btnSafe").addEventListener("click", () => {
    SAFE_MODE = !SAFE_MODE;
    applySafeMode();
  });

  applySafeMode();
</script>
</body>
</html>
