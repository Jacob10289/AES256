<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AES-256-GCM</title>
  <style>
    :root{
      --bg0:#05060a;
      --bg1:#070a12;
      --bg2:#0a1020;
      --fg:#f5f7ff;
      --line:rgba(255,255,255,.12);
      --panel:rgba(255,255,255,.045);
      --field:rgba(0,0,0,.30);
      --shadow:rgba(0,0,0,.70);
      --radius2:12px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      overflow:hidden;
      background:
        radial-gradient(1200px 900px at 15% 15%, rgba(120,160,255,.18), transparent 60%),
        radial-gradient(900px 700px at 85% 20%, rgba(90,220,255,.12), transparent 55%),
        radial-gradient(1200px 900px at 70% 85%, rgba(140,120,255,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
    }

    .sky{
      position:fixed; inset:0;
      z-index:0;
      pointer-events:none;
      overflow:hidden;
    }

    .stars{
      position:absolute; inset:-20%;
      background:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.9), transparent 55%),
        radial-gradient(1px 1px at 22% 78%, rgba(255,255,255,.7), transparent 55%),
        radial-gradient(1px 1px at 35% 35%, rgba(255,255,255,.8), transparent 55%),
        radial-gradient(1px 1px at 55% 18%, rgba(255,255,255,.6), transparent 55%),
        radial-gradient(1px 1px at 62% 62%, rgba(255,255,255,.75), transparent 55%),
        radial-gradient(1px 1px at 78% 42%, rgba(255,255,255,.65), transparent 55%),
        radial-gradient(1px 1px at 88% 72%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(1px 1px at 18% 55%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(1px 1px at 46% 84%, rgba(255,255,255,.55), transparent 55%),
        radial-gradient(1px 1px at 92% 28%, rgba(255,255,255,.55), transparent 55%);
      filter: drop-shadow(0 0 10px rgba(180,210,255,.08));
      opacity:.50;
      animation: drift 18s linear infinite, twinkle 3.8s ease-in-out infinite;
      transform:translate3d(0,0,0);
    }

    .haze{
      position:absolute; inset:-20%;
      background:
        radial-gradient(900px 700px at 18% 70%, rgba(120,160,255,.10), transparent 60%),
        radial-gradient(800px 600px at 80% 35%, rgba(90,220,255,.08), transparent 55%),
        radial-gradient(700px 520px at 55% 85%, rgba(160,120,255,.06), transparent 60%);
      filter: blur(18px);
      opacity:.70;
      animation: pulse 7.5s ease-in-out infinite;
    }

    .rain{
      position:absolute; inset:0;
      opacity:.55;
      filter: drop-shadow(0 0 8px rgba(140,190,255,.12));
      transform: translateZ(0);
    }

    .drop{
      position:absolute;
      top:-12vh;
      width:1px;
      height:12vh;
      background: linear-gradient(180deg, rgba(255,255,255,0), rgba(160,200,255,.55), rgba(255,255,255,0));
      opacity:.0;
      animation: fall var(--dur) linear var(--delay) infinite;
      transform: translateZ(0);
      will-change: transform, opacity;
    }

    @keyframes fall{
      0%{transform: translate3d(0,-12vh,0); opacity:0}
      10%{opacity:.55}
      90%{opacity:.55}
      100%{transform: translate3d(14vw,125vh,0); opacity:0}
    }

    @keyframes drift{
      0%{transform: translate3d(0,0,0) scale(1)}
      100%{transform: translate3d(-3%,2%,0) scale(1.02)}
    }
    @keyframes twinkle{
      0%,100%{opacity:.42}
      50%{opacity:.62}
    }
    @keyframes pulse{
      0%,100%{opacity:.68; transform:translate3d(0,0,0)}
      50%{opacity:.84; transform:translate3d(1.2%, -1%, 0)}
    }

    .wrap{
      position:relative;
      z-index:2;
      width:min(980px,92vw);
      padding:26px;
    }

    .box{
      width:100%;
      border-radius:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:
        0 24px 60px rgba(0,0,0,.55),
        inset 0 1px 0 rgba(255,255,255,.06);
      backdrop-filter: blur(10px);
      overflow:hidden;
      position:relative;
    }

    .box::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 300px at 10% 10%, rgba(120,160,255,.22), transparent 55%),
        radial-gradient(520px 320px at 90% 20%, rgba(90,220,255,.18), transparent 55%),
        radial-gradient(520px 320px at 70% 90%, rgba(160,120,255,.12), transparent 60%);
      filter: blur(18px);
      opacity:.55;
      pointer-events:none;
      animation: panelGlow 9s ease-in-out infinite;
    }
    @keyframes panelGlow{
      0%,100%{transform:translate3d(0,0,0); opacity:.50}
      50%{transform:translate3d(1%, -1%, 0); opacity:.68}
    }

    .inner{position:relative; padding:22px;}

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
      flex-wrap:nowrap;
    }
    h1{
      margin:0;
      font-size:16px;
      letter-spacing:.35px;
      opacity:.95;
      flex:1 1 auto;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-transform:uppercase;
    }
    .right{flex:0 0 auto; display:flex; justify-content:flex-end;}

    .row{display:flex;gap:12px;flex-wrap:wrap;margin:12px 0}
    .two{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      width:100%;
    }
    .two > button{width:100%}

    input,textarea,button{
      border-radius:var(--radius2);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.26);
      color:var(--fg);
      padding:13px 14px;
      font-size:14px;
      outline:none;
      transition: transform .14s ease, border-color .18s ease, background .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    input,textarea{flex:1;min-width:240px}
    textarea{width:100%;min-height:150px;resize:vertical;line-height:1.35}
    input::placeholder, textarea::placeholder{color:rgba(245,247,255,.45)}
    input:focus, textarea:focus{
      border-color: rgba(120,160,255,.45);
      box-shadow: 0 0 0 3px rgba(120,160,255,.15);
    }

    button{
      cursor:pointer;
      user-select:none;
      background:
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.20));
      border:1px solid rgba(255,255,255,.16);
    }
    button:hover{
      border-color: rgba(150,190,255,.35);
      box-shadow:
        0 10px 24px rgba(0,0,0,.35),
        0 0 0 3px rgba(120,160,255,.10);
      filter:saturate(1.08);
      transform: translateY(-1px);
    }
    button:active{
      transform: translateY(1px) scale(.99);
      box-shadow: 0 6px 14px rgba(0,0,0,.32);
    }

    .pillbtn{
      padding:9px 12px;
      border-radius:999px;
      font-size:12px;
      white-space:nowrap;
      letter-spacing:.2px;
      background:
        linear-gradient(90deg, rgba(120,160,255,.16), rgba(90,220,255,.10), rgba(160,120,255,.10));
      border-color: rgba(160,190,255,.22);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.08);
    }

    .mini{flex:0;min-width:190px}
    .pwwrap{display:flex;gap:12px;flex:1;min-width:260px}
    .pwwrap input{flex:1;min-width:0}
    .pwbtn{flex:0;min-width:130px}

    .disabled{
      opacity:.45;
      pointer-events:none;
      filter:saturate(.75);
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:28px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.72);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 14px;
      border-radius:12px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease, transform .18s ease;
      box-shadow:0 12px 26px rgba(0,0,0,.60);
      z-index:10;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-2px);
    }

    .modal{
      position:fixed; inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:20;
      padding:18px;
    }
    .modal.show{display:flex}
    .modal .backdrop{
      position:absolute; inset:0;
      background: rgba(0,0,0,.58);
      backdrop-filter: blur(6px);
    }
    .modal .card{
      position:relative;
      width:min(720px, 94vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.34));
      box-shadow: 0 30px 80px rgba(0,0,0,.65);
      overflow:hidden;
    }
    .modal .card::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(520px 260px at 15% 10%, rgba(120,160,255,.22), transparent 60%),
        radial-gradient(520px 260px at 85% 20%, rgba(90,220,255,.16), transparent 60%),
        radial-gradient(520px 260px at 60% 95%, rgba(160,120,255,.12), transparent 65%);
      filter: blur(18px);
      opacity:.65;
      pointer-events:none;
      animation: panelGlow 9s ease-in-out infinite;
    }
    .modal .content{position:relative; padding:18px;}
    .modal h2{
      margin:0 0 12px;
      font-size:16px;
      letter-spacing:.2px;
      opacity:.92;
    }
    .modal textarea{
      min-height:120px;
      width:100%;
      background: rgba(0,0,0,.30);
      border-color: rgba(255,255,255,.14);
    }
    .modal .actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .modal .actions button{min-width:130px;}
    .btn-primary{
      border-color: rgba(120,160,255,.28);
      background:
        linear-gradient(90deg, rgba(120,160,255,.24), rgba(90,220,255,.14), rgba(160,120,255,.14));
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
    }

    @media (max-width: 420px){
      input,textarea{min-width:0}
      .mini{min-width:0;flex:1}
      .pwbtn{min-width:110px}
      .pwwrap{min-width:0}
      .wrap{padding:18px}
      .inner{padding:18px}
    }
  </style>
</head>
<body>
  <div class="sky" aria-hidden="true">
    <div class="stars"></div>
    <div class="haze"></div>
    <div class="rain" id="rain"></div>
  </div>

  <div class="wrap">
    <div class="box">
      <div class="inner">
        <div class="top">
          <h1>AES-256-GCM</h1>
          <div class="right">
            <button id="btnSafe" class="pillbtn">BẢO MẬT : TẮT</button>
          </div>
        </div>

        <div class="row">
          <input id="plain" placeholder="Văn bản gốc" value="" autocomplete="off" />
          <input id="iters" class="mini" type="number" value="100000" min="100000" step="100000" inputmode="numeric" />
        </div>

        <div class="row">
          <div class="pwwrap">
            <input id="pass" type="password" placeholder="Mật khẩu" autocomplete="new-password" />
            <button id="btnTogglePass" class="pwbtn">HIỆN</button>
          </div>
        </div>

        <div class="row two">
          <button id="btnEnc" class="btn-primary">MÃ HOÁ</button>
          <button id="btnDec">GIẢI MÃ</button>
        </div>

        <div class="row">
          <textarea id="token" spellcheck="false" placeholder="Token mã hoá"></textarea>
        </div>

        <div class="row two">
          <button id="btnCopy">SAO CHÉP</button>
          <button id="btnClear">XOÁ</button>
        </div>

        <div class="row">
          <input id="out" placeholder="Kết quả" autocomplete="off" />
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">OK</div>

  <div id="modalPlain" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="backdrop" data-close="1"></div>
    <div class="card">
      <div class="content">
        <h2>Nhập văn bản gốc để mã hoá</h2>
        <textarea id="modalPlainText" spellcheck="false" placeholder="Nhập nội dung..."></textarea>
        <div class="actions">
          <button id="modalPlainCancel">Huỷ</button>
          <button id="modalPlainOk" class="btn-primary">OK</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalOut" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="backdrop" data-close="1"></div>
    <div class="card">
      <div class="content">
        <h2>Kết quả giải mã</h2>
        <textarea id="modalOutText" spellcheck="false" readonly></textarea>
        <div class="actions">
          <button id="modalOutCopy">Sao chép</button>
          <button id="modalOutClose" class="btn-primary">Đóng</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const enc = new TextEncoder();
  const dec = new TextDecoder();

  const b64url = (u8) =>
    btoa(String.fromCharCode(...u8))
      .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

  const b64urlToU8 = (s) => {
    s = s.replace(/-/g,'+').replace(/_/g,'/');
    s += '='.repeat((4 - (s.length % 4)) % 4);
    const bin = atob(s);
    const u8 = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
    return u8;
  };

  const getIters = () => {
    const n = parseInt($("iters").value || "100000", 10);
    return Number.isFinite(n) ? Math.max(100000, n) : 100000;
  };

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 900);
  }

  let SAFE_MODE = false;

  const disableInSafeMode = ["plain","btnTogglePass","out"];

  function setDisabled(id, on){
    const el = $(id);
    if (!el) return;
    el.disabled = !!on;
    if (on) el.classList.add("disabled");
    else el.classList.remove("disabled");
  }

  function applySafeMode(){
    $("btnSafe").textContent = `BẢO MẬT : ${SAFE_MODE ? "BẬT" : "TẮT"}`;

    if (SAFE_MODE) {
      $("plain").value = "";
      $("out").value = "";
      $("pass").value = "";

      $("pass").type = "password";
      $("btnTogglePass").textContent = "HIỆN";

      disableInSafeMode.forEach(id => setDisabled(id, true));

      $("plain").placeholder = "Văn bản gốc";
      $("out").placeholder = "Kết quả";

      toast("Đã bật bảo mật");
    } else {
      disableInSafeMode.forEach(id => setDisabled(id, false));
      $("plain").placeholder = "Văn bản gốc";
      $("out").placeholder = "Kết quả";
      toast("Đã tắt bảo mật");
    }
  }

  async function deriveAesKeyFromPass(pass, saltU8, iters) {
    const passKey = await crypto.subtle.importKey(
      "raw",
      enc.encode(pass),
      { name: "PBKDF2" },
      false,
      ["deriveKey"]
    );

    return crypto.subtle.deriveKey(
      { name: "PBKDF2", salt: saltU8, iterations: iters, hash: "SHA-256" },
      passKey,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"]
    );
  }

  function showModalPlain() {
    return new Promise((resolve) => {
      const m = $("modalPlain");
      const t = $("modalPlainText");
      const ok = $("modalPlainOk");
      const cancel = $("modalPlainCancel");

      const close = (val) => {
        m.classList.remove("show");
        m.setAttribute("aria-hidden","true");
        ok.removeEventListener("click", onOk);
        cancel.removeEventListener("click", onCancel);
        m.querySelector(".backdrop").removeEventListener("click", onBackdrop);
        document.removeEventListener("keydown", onKey);
        resolve(val);
      };

      const onOk = () => close((t.value ?? "").trim());
      const onCancel = () => close("");
      const onBackdrop = () => close("");
      const onKey = (e) => {
        if (e.key === "Escape") close("");
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") onOk();
      };

      t.value = "";
      m.classList.add("show");
      m.setAttribute("aria-hidden","false");
      setTimeout(()=>t.focus(), 40);

      ok.addEventListener("click", onOk);
      cancel.addEventListener("click", onCancel);
      m.querySelector(".backdrop").addEventListener("click", onBackdrop);
      document.addEventListener("keydown", onKey);
    });
  }

  function showModalOut(text) {
    const m = $("modalOut");
    const t = $("modalOutText");
    const closeBtn = $("modalOutClose");
    const copyBtn = $("modalOutCopy");

    const close = () => {
      m.classList.remove("show");
      m.setAttribute("aria-hidden","true");
      closeBtn.removeEventListener("click", onClose);
      copyBtn.removeEventListener("click", onCopy);
      m.querySelector(".backdrop").removeEventListener("click", onBackdrop);
      document.removeEventListener("keydown", onKey);
    };

    const onClose = () => close();
    const onBackdrop = () => close();
    const onKey = (e) => { if (e.key === "Escape") close(); };

    const onCopy = async () => {
      try{
        await navigator.clipboard.writeText(text);
        toast("Đã sao chép");
      }catch{
        t.focus();
        t.select();
        document.execCommand("copy");
        toast("Đã sao chép");
      }
    };

    t.value = text || "";
    m.classList.add("show");
    m.setAttribute("aria-hidden","false");
    setTimeout(()=>t.focus(), 40);

    closeBtn.addEventListener("click", onClose);
    copyBtn.addEventListener("click", onCopy);
    m.querySelector(".backdrop").addEventListener("click", onBackdrop);
    document.addEventListener("keydown", onKey);
  }

  async function getPlaintextForEncrypt(){
    if (!SAFE_MODE) return ($("plain").value ?? "").trim();
    return await showModalPlain();
  }

  function setOutputAfterDecrypt(text){
    if (SAFE_MODE) {
      $("out").value = "";
      showModalOut(text);
    } else {
      $("out").value = text;
    }
  }

  function clearSensitive(){
    $("pass").value = "";
    if (SAFE_MODE) $("plain").value = "";
  }

  async function encrypt() {
    try {
      const plain = await getPlaintextForEncrypt();
      const pass = $("pass").value;

      if (!plain) throw new Error("Bạn chưa nhập văn bản gốc.");
      if (!pass || pass.length < 10) throw new Error("Mật khẩu quá yếu.");

      const iters = getIters();
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const nonce = crypto.getRandomValues(new Uint8Array(12));

      const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

      const ctAll = new Uint8Array(await crypto.subtle.encrypt(
        { name: "AES-GCM", iv: nonce },
        aesKey,
        enc.encode(plain)
      ));

      const ciphertext = ctAll.slice(0, ctAll.length - 16);
      const tag = ctAll.slice(ctAll.length - 16);

      $("token").value = `v3.${iters}.${b64url(salt)}.${b64url(nonce)}.${b64url(ciphertext)}.${b64url(tag)}`;

      clearSensitive();
      toast("Đã mã hoá");
    } catch (e) {
      toast("Có lỗi");
      if (!SAFE_MODE) $("out").value = "Mã hoá thất bại: " + (e?.message || e);
    }
  }

  async function decrypt() {
    try {
      const pass = $("pass").value.trim();
      const token = $("token").value.trim();

      if (!pass) throw new Error("Bạn chưa nhập mật khẩu.");
      if (!token) throw new Error("Bạn chưa dán token.");

      const parts = token.split(".");
      if (parts.length !== 6 || parts[0] !== "v3") throw new Error("Token không đúng định dạng.");

      const iters = parseInt(parts[1], 10);
      if (!Number.isFinite(iters) || iters < 100000) throw new Error("Iterations trong token không hợp lệ.");

      const salt = b64urlToU8(parts[2]);
      const nonce = b64urlToU8(parts[3]);
      const ciphertext = b64urlToU8(parts[4]);
      const tag = b64urlToU8(parts[5]);

      const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

      const ctAll = new Uint8Array(ciphertext.length + tag.length);
      ctAll.set(ciphertext, 0);
      ctAll.set(tag, ciphertext.length);

      const pt = new Uint8Array(await crypto.subtle.decrypt(
        { name: "AES-GCM", iv: nonce },
        aesKey,
        ctAll
      ));

      const text = dec.decode(pt);
      setOutputAfterDecrypt(text);
      clearSensitive();
      toast("Đã giải mã");
    } catch (e) {
      toast("Có lỗi");
      if (!SAFE_MODE) $("out").value = "Giải mã thất bại: " + (e?.message || e);
    }
  }

  async function copyToken(){
    const token = $("token").value.trim();
    if (!token) return toast("Chưa có token");
    try{
      await navigator.clipboard.writeText(token);
      toast("Đã sao chép");
    }catch{
      $("token").focus();
      $("token").select();
      document.execCommand("copy");
      toast("Đã sao chép");
    }
  }

  function clearAll(){
    if (SAFE_MODE) $("plain").value = "";
    $("pass").value = "";
    $("token").value = "";
    $("out").value = "";
    toast("Đã xoá");
  }

  function togglePass(){
    if (SAFE_MODE) return;
    const p = $("pass");
    const isPw = p.type === "password";
    p.type = isPw ? "text" : "password";
    $("btnTogglePass").textContent = isPw ? "ẨN" : "HIỆN";
  }

  function spawnRain(){
    const host = $("rain");
    host.innerHTML = "";
    const isMobile = matchMedia("(max-width: 520px)").matches;
    const count = isMobile ? 48 : 72;

    for (let i=0;i<count;i++){
      const d = document.createElement("div");
      d.className = "drop";
      const left = Math.random() * 110;
      const delay = Math.random() * 1.8;
      const dur = 0.95 + Math.random() * 0.75;
      const h = 9 + Math.random() * 14;
      const tilt = 10 + Math.random() * 12;

      d.style.left = left + "vw";
      d.style.height = h + "vh";
      d.style.opacity = (0.22 + Math.random() * 0.35).toFixed(2);
      d.style.setProperty("--delay", delay + "s");
      d.style.setProperty("--dur", dur + "s");
      d.style.transform = `rotate(${tilt}deg)`;
      host.appendChild(d);
    }
  }

  $("btnEnc").addEventListener("click", encrypt);
  $("btnDec").addEventListener("click", decrypt);
  $("btnCopy").addEventListener("click", copyToken);
  $("btnClear").addEventListener("click", clearAll);
  $("btnTogglePass").addEventListener("click", togglePass);

  $("btnSafe").addEventListener("click", () => {
    SAFE_MODE = !SAFE_MODE;
    applySafeMode();
  });

  spawnRain();
  window.addEventListener("resize", () => {
    clearTimeout(window.__rainT);
    window.__rainT = setTimeout(spawnRain, 160);
  });

  applySafeMode();
</script>
</body>
</html>
