<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AES-256-GCM</title>
  <style>
    :root{
      --bg0:#05060a;
      --bg1:#0a1020;
      --fg:#eef2ff;

      --line:rgba(255,255,255,.10);
      --shadow:rgba(0,0,0,.78);

      --card:rgba(10,12,18,.58);
      --field:rgba(10,12,18,.52);

      --gbtn:linear-gradient(135deg, rgba(82,170,255,.26), rgba(148,92,255,.20), rgba(0,255,209,.14));
      --gsoft:linear-gradient(135deg, rgba(255,255,255,.05), rgba(0,0,0,.24));

      --r:14px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      min-height:100%;
      padding:18px 0;
      display:flex;
      justify-content:center;
      align-items:flex-start;
      color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      overflow:auto;
      -webkit-overflow-scrolling:touch;
      background:
        radial-gradient(1100px 800px at 18% 16%, rgba(82,170,255,.14), transparent 62%),
        radial-gradient(900px 700px at 88% 18%, rgba(148,92,255,.11), transparent 60%),
        radial-gradient(900px 740px at 55% 92%, rgba(0,255,209,.08), transparent 64%),
        linear-gradient(180deg,var(--bg0),var(--bg1));
    }

    .glow{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      opacity:.95;
      background:
        radial-gradient(900px 650px at 30% 22%, rgba(255,255,255,.05), transparent 68%),
        radial-gradient(900px 650px at 80% 34%, rgba(255,255,255,.035), transparent 70%),
        radial-gradient(900px 650px at 50% 88%, rgba(255,255,255,.025), transparent 70%);
    }

    .meteorLayer{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:1;
      overflow:hidden;
      opacity:.9;
    }

    .meteor{
      position:absolute;
      top:-20vh;
      left:-20vw;
      width:2px;
      height:140px;
      transform:rotate(32deg);
      background:linear-gradient(180deg, rgba(255,255,255,.0), rgba(160,210,255,.55), rgba(255,255,255,.0));
      filter:drop-shadow(0 0 8px rgba(120,190,255,.25));
      animation:shoot 3.8s linear infinite;
      will-change:transform,opacity;
      opacity:0;
    }

    .meteor:after{
      content:"";
      position:absolute;
      top:6px;
      left:-34px;
      width:70px;
      height:2px;
      background:linear-gradient(90deg, rgba(255,255,255,.0), rgba(180,220,255,.55), rgba(255,255,255,.0));
      filter:blur(.1px);
      opacity:.9;
    }

    @keyframes shoot{
      0%{transform:translate3d(-20vw,-18vh,0) rotate(32deg); opacity:0}
      8%{opacity:.9}
      35%{opacity:.9}
      55%{opacity:0}
      100%{transform:translate3d(140vw,120vh,0) rotate(32deg); opacity:0}
    }

    .meteor:nth-child(1){top:-10vh; left:-30vw; animation-delay:.6s}
    .meteor:nth-child(2){top:-22vh; left:-10vw; animation-delay:2.4s; height:170px; opacity:.0}
    .meteor:nth-child(3){top:-18vh; left:-45vw; animation-delay:4.2s; height:130px}
    .meteor:nth-child(4){top:-28vh; left:-20vw; animation-delay:6.2s; height:160px; opacity:.0}
    .meteor:nth-child(5){top:-14vh; left:-55vw; animation-delay:8.0s; height:150px}

    @media (prefers-reduced-motion: reduce){
      .meteorLayer{display:none}
    }

    .wrap{
      position:relative;
      z-index:2;
      width:min(980px,92vw);
      padding:0 16px 16px;
    }

    .shell{
      border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid rgba(255,255,255,.11);
      box-shadow:0 30px 80px rgba(0,0,0,.62), inset 0 1px 0 rgba(255,255,255,.06);
      backdrop-filter:blur(10px);
      overflow:hidden;
    }

    .appbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(120% 160% at 20% 30%, rgba(82,170,255,.14), transparent 55%),
        radial-gradient(120% 160% at 86% 20%, rgba(148,92,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(0,0,0,.22), rgba(0,0,0,.06));
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }

    .brand .t{
      font-size:13px;
      letter-spacing:.6px;
      text-transform:uppercase;
      opacity:.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .actions{
      display:flex;
      gap:10px;
      align-items:center;
      flex:0 0 auto;
    }

    .content{padding:18px}

    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin:12px 0;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      width:100%;
    }

    .grid2 > *{width:100%}

    input,textarea,button,label{
      border-radius:var(--r);
      border:1px solid rgba(255,255,255,.12);
      background:var(--field);
      color:var(--fg);
      padding:13px 14px;
      font-size:14px;
      outline:none;
      transition:transform .14s ease,border-color .18s ease,background .18s ease,box-shadow .18s ease,filter .18s ease;
    }

    textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      line-height:1.35;
    }

    input,textarea{flex:1;min-width:240px}
    input::placeholder,textarea::placeholder{color:rgba(238,242,255,.42)}

    input:focus,textarea:focus{
      border-color:rgba(180,210,255,.26);
      box-shadow:0 0 0 3px rgba(120,170,255,.10);
    }

    button,label{
      cursor:pointer;
      user-select:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.22));
    }

    button:hover,label:hover{
      border-color:rgba(230,235,255,.22);
      box-shadow:0 14px 28px rgba(0,0,0,.44),0 0 0 3px rgba(120,170,255,.07);
      transform:translateY(-1px);
      filter:saturate(1.06);
    }

    button:active,label:active{transform:translateY(1px) scale(.99)}

    .pill{
      padding:9px 12px;
      border-radius:999px;
      font-size:12px;
      white-space:nowrap;
      background:linear-gradient(135deg, rgba(82,170,255,.18), rgba(148,92,255,.12), rgba(0,255,209,.10));
      border-color:rgba(255,255,255,.16);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.08);
    }

    .btnG{
      background:var(--gbtn);
      border-color:rgba(190,220,255,.18);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.10);
    }

    .btnSoft{background:var(--gsoft)}

    .danger{
      background:linear-gradient(135deg, rgba(255,80,110,.14), rgba(148,92,255,.12), rgba(0,0,0,.22));
      border-color:rgba(255,255,255,.12);
    }

    .mini{flex:0;min-width:190px}
    .pwwrap{display:flex;gap:12px;flex:1;min-width:260px}
    .pwwrap input{flex:1;min-width:0}
    .pwbtn{flex:0;min-width:130px}

    .filemeta{
      flex:1 1 auto;
      min-width:240px;
      padding:13px 14px;
      border-radius:var(--r);
      border:1px solid rgba(255,255,255,.10);
      background:var(--field);
      color:rgba(238,242,255,.78);
    }

    .mono{
      font-variant-ligatures:none;
      font-feature-settings:"liga" 0;
      letter-spacing:.15px;
      word-break:break-word;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:22px;
      transform:translateX(-50%);
      background:rgba(0,0,0,.74);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 14px;
      border-radius:12px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition:opacity .18s ease,transform .18s ease;
      box-shadow:0 12px 26px var(--shadow);
      z-index:30;
    }

    .toast.show{opacity:1;transform:translateX(-50%) translateY(-2px)}
    .disabled{opacity:.45;pointer-events:none;filter:saturate(.75)}

    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
      padding:18px;
    }

    .modal.show{display:flex}

    .modal .backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.62);
      backdrop-filter:blur(6px);
    }

    .modal .card{
      position:relative;
      width:min(760px, 94vw);
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(140% 160% at 20% 18%, rgba(82,170,255,.12), transparent 55%),
        radial-gradient(140% 160% at 88% 20%, rgba(148,92,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.055), rgba(0,0,0,.44));
      box-shadow:0 30px 80px rgba(0,0,0,.70);
      overflow:hidden;
    }

    .modal .content{position:relative;padding:18px}
    .modal h2{margin:0 0 12px;font-size:15px;letter-spacing:.2px;opacity:.92}
    .modal textarea{min-height:140px;width:100%;background:rgba(0,0,0,.34);border-color:rgba(255,255,255,.14)}
    .modal .actions{
      display:flex;
      gap:12px;
      justify-content:flex-end;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .modal .actions button{min-width:130px}

    @media (max-width:420px){
      input,textarea{min-width:0}
      .mini{min-width:0;flex:1}
      .pwbtn{min-width:110px}
      .pwwrap{min-width:0}
      body{padding:14px 0}
      .wrap{padding:0 14px 14px}
      .content{padding:16px}
      textarea{min-height:150px}
    }
  </style>
</head>
<body>
  <div class="glow" aria-hidden="true"></div>

  <div class="meteorLayer" aria-hidden="true">
    <span class="meteor"></span>
    <span class="meteor"></span>
    <span class="meteor"></span>
    <span class="meteor"></span>
    <span class="meteor"></span>
  </div>

  <div class="wrap">
    <div class="shell">
      <div class="appbar">
        <div class="brand">
          <div class="t">AES-256-GCM</div>
        </div>
        <div class="actions">
          <button id="btnSafe" class="pill">BẢO MẬT : TẮT</button>
        </div>
      </div>

      <div class="content">
        <div class="row">
          <input id="plain" placeholder="Văn bản gốc" value="" autocomplete="off" />
          <input id="iters" class="mini" type="number" value="100000" min="100000" step="100000" inputmode="numeric" />
        </div>

        <div class="row">
          <div class="pwwrap">
            <input id="pass" type="password" placeholder="Mật khẩu" autocomplete="new-password" />
            <button id="btnTogglePass" class="pwbtn btnSoft">HIỆN</button>
          </div>
        </div>

        <div class="row grid2">
          <button id="btnEncrypt" class="btnG">MÃ HOÁ</button>
          <button id="btnDecrypt" class="btnSoft">GIẢI MÃ</button>
        </div>

        <div class="row grid2">
          <label for="file" id="btnPick" class="btnG">CHỌN FILE</label>
          <button id="btnDownload" class="btnSoft">TẢI FILE</button>
        </div>

        <div class="row">
          <input id="file" type="file" hidden />
          <div id="filemeta" class="filemeta mono">Chưa chọn file</div>
        </div>

        <div class="row">
          <textarea id="token" class="mono" spellcheck="false" placeholder="Token mã hoá (v3... hoặc v3f...)"></textarea>
        </div>

        <div class="row grid2">
          <button id="btnCopy" class="btnSoft">SAO CHÉP</button>
          <button id="btnClear" class="danger">XOÁ</button>
        </div>

        <div class="row">
          <input id="out" placeholder="Kết quả" autocomplete="off" />
        </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast">OK</div>

  <div id="modalPlain" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="card">
      <div class="content">
        <h2>Nhập văn bản gốc</h2>
        <textarea id="modalPlainText" spellcheck="false" placeholder="Nhập nội dung..."></textarea>
        <div class="actions">
          <button id="modalPlainCancel">Huỷ</button>
          <button id="modalPlainOk" class="btnG">OK</button>
        </div>
      </div>
    </div>
  </div>

  <div id="modalOut" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="backdrop"></div>
    <div class="card">
      <div class="content">
        <h2>Kết quả</h2>
        <textarea id="modalOutText" spellcheck="false" readonly></textarea>
        <div class="actions">
          <button id="modalOutCopy">Sao chép</button>
          <button id="modalOutClose" class="btnG">Đóng</button>
        </div>
      </div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);
  const enc = new TextEncoder();
  const dec = new TextDecoder();

  const u8ToB64 = (u8) => {
    const CHUNK = 0x8000;
    let s = "";
    for (let i = 0; i < u8.length; i += CHUNK) s += String.fromCharCode.apply(null, u8.subarray(i, i + CHUNK));
    return btoa(s);
  };

  const b64ToU8 = (b64) => {
    const bin = atob(b64);
    const u8 = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) u8[i] = bin.charCodeAt(i);
    return u8;
  };

  const b64url = (u8) => u8ToB64(u8).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  const b64urlToU8 = (s) => {
    s = (s || "").replace(/-/g,'+').replace(/_/g,'/');
    s += '='.repeat((4 - (s.length % 4)) % 4);
    return b64ToU8(s);
  };

  const strToB64url = (s) => b64url(enc.encode(s));
  const b64urlToStr = (s) => dec.decode(b64urlToU8(s));

  const getIters = () => {
    const n = parseInt($("iters").value || "100000", 10);
    return Number.isFinite(n) ? Math.max(100000, n) : 100000;
  };

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 900);
  }

  let SAFE_MODE = false;
  const disableInSafeMode = ["plain","btnTogglePass","out"];

  function setDisabled(id, on){
    const el = $(id);
    if (!el) return;
    el.disabled = !!on;
    if (on) el.classList.add("disabled");
    else el.classList.remove("disabled");
  }

  function applySafeMode(){
    $("btnSafe").textContent = `BẢO MẬT : ${SAFE_MODE ? "BẬT" : "TẮT"}`;
    if (SAFE_MODE) {
      $("plain").value = "";
      $("out").value = "";
      $("pass").type = "password";
      $("btnTogglePass").textContent = "HIỆN";
      disableInSafeMode.forEach(id => setDisabled(id, true));
      toast("Đã bật bảo mật");
    } else {
      disableInSafeMode.forEach(id => setDisabled(id, false));
      toast("Đã tắt bảo mật");
    }
  }

  async function deriveAesKeyFromPass(pass, saltU8, iters) {
    const passKey = await crypto.subtle.importKey("raw", enc.encode(pass), { name:"PBKDF2" }, false, ["deriveKey"]);
    return crypto.subtle.deriveKey(
      { name:"PBKDF2", salt:saltU8, iterations:iters, hash:"SHA-256" },
      passKey,
      { name:"AES-GCM", length:256 },
      false,
      ["encrypt","decrypt"]
    );
  }

  function modalOpen(id){
    const m = $(id);
    m.classList.add("show");
    m.setAttribute("aria-hidden","false");
  }
  function modalClose(id){
    const m = $(id);
    m.classList.remove("show");
    m.setAttribute("aria-hidden","true");
  }

  function showModalPlain(){
    return new Promise((resolve) => {
      const mId = "modalPlain";
      const m = $(mId);
      const t = $("modalPlainText");
      const ok = $("modalPlainOk");
      const cancel = $("modalPlainCancel");
      const backdrop = m.querySelector(".backdrop");

      const cleanup = () => {
        ok.removeEventListener("click", onOk);
        cancel.removeEventListener("click", onCancel);
        backdrop.removeEventListener("click", onCancel);
        document.removeEventListener("keydown", onKey);
      };

      const finish = (val) => {
        cleanup();
        modalClose(mId);
        resolve(val);
      };

      const onOk = () => finish((t.value ?? "").trim());
      const onCancel = () => finish("");
      const onKey = (e) => {
        if (e.key === "Escape") onCancel();
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") onOk();
      };

      t.value = "";
      modalOpen(mId);
      setTimeout(()=>t.focus(), 40);

      ok.addEventListener("click", onOk);
      cancel.addEventListener("click", onCancel);
      backdrop.addEventListener("click", onCancel);
      document.addEventListener("keydown", onKey);
    });
  }

  async function showModalOut(text){
    const mId = "modalOut";
    const m = $(mId);
    const t = $("modalOutText");
    const close = $("modalOutClose");
    const copy = $("modalOutCopy");
    const backdrop = m.querySelector(".backdrop");

    const cleanup = () => {
      close.removeEventListener("click", onClose);
      copy.removeEventListener("click", onCopy);
      backdrop.removeEventListener("click", onClose);
      document.removeEventListener("keydown", onKey);
    };

    const onClose = () => { cleanup(); modalClose(mId); };
    const onKey = (e) => { if (e.key === "Escape") onClose(); };

    const onCopy = async () => {
      try{
        await navigator.clipboard.writeText(text || "");
        toast("Đã sao chép");
      }catch{
        t.focus(); t.select();
        document.execCommand("copy");
        toast("Đã sao chép");
      }
    };

    t.value = text || "";
    modalOpen(mId);
    setTimeout(()=>t.focus(), 40);

    close.addEventListener("click", onClose);
    copy.addEventListener("click", onCopy);
    backdrop.addEventListener("click", onClose);
    document.addEventListener("keydown", onKey);
  }

  async function getPlaintextForEncrypt(){
    if (!SAFE_MODE) return ($("plain").value || "").trim();
    return await showModalPlain();
  }

  function clearSensitiveAfterUse(){
    if (SAFE_MODE) $("pass").value = "";
    if (SAFE_MODE) $("plain").value = "";
  }

  let SELECTED_FILE = null;
  let LAST_DECRYPTED_FILE = null;

  $("file").addEventListener("change", () => {
    const f = $("file").files && $("file").files[0];
    SELECTED_FILE = f || null;
    if (!SELECTED_FILE) {
      $("filemeta").textContent = "Chưa chọn file";
      return;
    }
    const kb = SELECTED_FILE.size / 1024;
    const s = kb < 1024 ? `${kb.toFixed(1)} KB` : `${(kb/1024).toFixed(2)} MB`;
    $("filemeta").textContent = `${SELECTED_FILE.name} • ${s} • ${SELECTED_FILE.type || "application/octet-stream"}`;
  });

  async function encryptText(){
    const plain = await getPlaintextForEncrypt();
    const pass = $("pass").value;

    if (!plain) throw new Error("Bạn chưa nhập văn bản gốc.");
    if (!pass || pass.length < 10) throw new Error("Mật khẩu quá yếu.");

    const iters = getIters();
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const nonce = crypto.getRandomValues(new Uint8Array(12));
    const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

    const ctAll = new Uint8Array(await crypto.subtle.encrypt({ name:"AES-GCM", iv: nonce }, aesKey, enc.encode(plain)));
    const ciphertext = ctAll.slice(0, ctAll.length - 16);
    const tag = ctAll.slice(ctAll.length - 16);

    $("token").value = `v3.${iters}.${b64url(salt)}.${b64url(nonce)}.${b64url(ciphertext)}.${b64url(tag)}`;
    clearSensitiveAfterUse();
    toast("Đã mã hoá");
  }

  async function encryptFile(){
    if (!SELECTED_FILE) throw new Error("Bạn chưa chọn file.");
    const pass = $("pass").value;
    if (!pass || pass.length < 10) throw new Error("Mật khẩu quá yếu.");

    const iters = getIters();
    const salt = crypto.getRandomValues(new Uint8Array(16));
    const nonce = crypto.getRandomValues(new Uint8Array(12));
    const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

    const buf = await SELECTED_FILE.arrayBuffer();
    const data = new Uint8Array(buf);

    const ctAll = new Uint8Array(await crypto.subtle.encrypt({ name:"AES-GCM", iv: nonce }, aesKey, data));
    const ciphertext = ctAll.slice(0, ctAll.length - 16);
    const tag = ctAll.slice(ctAll.length - 16);

    const nameB64 = strToB64url(SELECTED_FILE.name);
    const mimeB64 = strToB64url(SELECTED_FILE.type || "application/octet-stream");

    $("token").value = `v3f.${iters}.${b64url(salt)}.${b64url(nonce)}.${nameB64}.${mimeB64}.${b64url(ciphertext)}.${b64url(tag)}`;
    clearSensitiveAfterUse();
    toast("Đã mã hoá file");
  }

  async function encryptUnified(){
    try{
      if (SELECTED_FILE) await encryptFile();
      else await encryptText();
    }catch(e){
      toast("Có lỗi");
      if (!SAFE_MODE) $("out").value = "Mã hoá thất bại: " + (e?.message || e);
    }
  }

  async function decryptAny(){
    try{
      const pass = ($("pass").value || "").trim();
      const token = ($("token").value || "").trim();

      if (!pass) throw new Error("Bạn chưa nhập mật khẩu.");
      if (!token) throw new Error("Bạn chưa dán token.");

      const parts = token.split(".");
      const ver = parts[0];

      if (ver === "v3") {
        if (parts.length !== 6) throw new Error("Token v3 không đúng định dạng.");

        const iters = parseInt(parts[1], 10);
        if (!Number.isFinite(iters) || iters < 100000) throw new Error("Iterations không hợp lệ.");

        const salt = b64urlToU8(parts[2]);
        const nonce = b64urlToU8(parts[3]);
        const ciphertext = b64urlToU8(parts[4]);
        const tag = b64urlToU8(parts[5]);

        const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

        const ctAll = new Uint8Array(ciphertext.length + tag.length);
        ctAll.set(ciphertext, 0);
        ctAll.set(tag, ciphertext.length);

        const pt = new Uint8Array(await crypto.subtle.decrypt({ name:"AES-GCM", iv: nonce }, aesKey, ctAll));
        const text = dec.decode(pt);

        LAST_DECRYPTED_FILE = null;

        if (SAFE_MODE) { $("out").value = ""; await showModalOut(text); }
        else $("out").value = text;

        clearSensitiveAfterUse();
        toast("Đã giải mã");
        return;
      }

      if (ver === "v3f") {
        if (parts.length !== 8) throw new Error("Token v3f không đúng định dạng.");

        const iters = parseInt(parts[1], 10);
        if (!Number.isFinite(iters) || iters < 100000) throw new Error("Iterations không hợp lệ.");

        const salt = b64urlToU8(parts[2]);
        const nonce = b64urlToU8(parts[3]);
        const fileName = b64urlToStr(parts[4]);
        const mime = b64urlToStr(parts[5]);
        const ciphertext = b64urlToU8(parts[6]);
        const tag = b64urlToU8(parts[7]);

        const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

        const ctAll = new Uint8Array(ciphertext.length + tag.length);
        ctAll.set(ciphertext, 0);
        ctAll.set(tag, ciphertext.length);

        const pt = new Uint8Array(await crypto.subtle.decrypt({ name:"AES-GCM", iv: nonce }, aesKey, ctAll));
        LAST_DECRYPTED_FILE = { name: fileName || "file.bin", mime: mime || "application/octet-stream", bytes: pt };

        const msg = `Đã giải mã file: ${LAST_DECRYPTED_FILE.name} (${LAST_DECRYPTED_FILE.bytes.length} bytes)`;

        if (SAFE_MODE) { $("out").value = ""; await showModalOut(msg); }
        else $("out").value = msg;

        clearSensitiveAfterUse();
        toast("Đã giải mã file");
        return;
      }

      throw new Error("Token không hỗ trợ (chỉ v3 hoặc v3f).");
    }catch(e){
      toast("Có lỗi");
      if (!SAFE_MODE) $("out").value = "Giải mã thất bại: " + (e?.message || e);
      LAST_DECRYPTED_FILE = null;
    }
  }

  function downloadDecryptedFile(){
    if (!LAST_DECRYPTED_FILE) return toast("Chưa có file để tải");
    const blob = new Blob([LAST_DECRYPTED_FILE.bytes], { type: LAST_DECRYPTED_FILE.mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = LAST_DECRYPTED_FILE.name;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1500);
    toast("Đang tải file");
  }

  async function copyToken(){
    const token = ($("token").value || "").trim();
    if (!token) return toast("Chưa có token");
    try{
      await navigator.clipboard.writeText(token);
      toast("Đã sao chép");
    }catch{
      $("token").focus();
      $("token").select();
      document.execCommand("copy");
      toast("Đã sao chép");
    }
  }

  function clearAll(){
    if (SAFE_MODE) $("plain").value = "";
    $("token").value = "";
    $("out").value = "";
    SELECTED_FILE = null;
    $("file").value = "";
    $("filemeta").textContent = "Chưa chọn file";
    LAST_DECRYPTED_FILE = null;
    if (SAFE_MODE) $("pass").value = "";
    toast("Đã xoá");
  }

  function togglePass(){
    if (SAFE_MODE) return;
    const p = $("pass");
    const isPw = p.type === "password";
    p.type = isPw ? "text" : "password";
    $("btnTogglePass").textContent = isPw ? "ẨN" : "HIỆN";
  }

  $("btnEncrypt").addEventListener("click", encryptUnified);
  $("btnDecrypt").addEventListener("click", decryptAny);
  $("btnDownload").addEventListener("click", downloadDecryptedFile);
  $("btnCopy").addEventListener("click", copyToken);
  $("btnClear").addEventListener("click", clearAll);
  $("btnTogglePass").addEventListener("click", togglePass);

  $("btnSafe").addEventListener("click", () => {
    SAFE_MODE = !SAFE_MODE;
    applySafeMode();
  });

  applySafeMode();
</script>
</body>
</html>
