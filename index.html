<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AES-256-GCM Encoder</title>
  <style>
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:#0b0b0f;color:#f5f5f7;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .box{width:min(900px,92vw);padding:24px;border:1px solid rgba(255,255,255,.12);border-radius:16px;background:rgba(255,255,255,.04)}
    h1{margin:0 0 10px;font-size:18px;opacity:.9}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    input,textarea,button{border-radius:12px;border:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.25);color:#fff;padding:12px 14px;font-size:14px}
    input,textarea{flex:1;min-width:240px}
    textarea{width:100%;min-height:88px;resize:vertical}
    button{cursor:pointer}
    .hint{opacity:.7;font-size:12px;line-height:1.4;margin-top:8px}
    code{word-break:break-all}
  </style>
</head>
<body>
  <div class="box">
    <h1>AES-256-GCM (WebCrypto) — Mã hoá / Giải mã</h1>

    <div class="row">
      <input id="plain" value="Pham Duong" />
      <button id="btnEnc">Encrypt</button>
    </div>

    <div class="row">
      <textarea id="key" placeholder="KEY (b64url) sẽ xuất hiện ở đây..."></textarea>
    </div>

    <div class="row">
      <textarea id="token" placeholder="TOKEN v1.<nonce>.<ciphertext>.<tag> sẽ xuất hiện ở đây..."></textarea>
    </div>

    <div class="row">
      <button id="btnDec">Decrypt (dùng KEY + TOKEN)</button>
      <input id="out" placeholder="Kết quả giải mã..." />
    </div>

    <div class="hint">
      - TOKEN format: <code>v1.&lt;nonce&gt;.&lt;ciphertext&gt;.&lt;tag&gt;</code> (Base64URL, bỏ dấu "=")<br>
      - Không được dùng lại nonce với cùng key (GCM kỵ reuse IV).
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const b64url = (u8) =>
    btoa(String.fromCharCode(...u8))
      .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

  const b64urlToU8 = (s) => {
    s = s.replace(/-/g,'+').replace(/_/g,'/');
    s += '='.repeat((4 - (s.length % 4)) % 4);
    const bin = atob(s);
    const u8 = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
    return u8;
  };

  async function encrypt() {
    const enc = new TextEncoder();
    const plain = enc.encode($("plain").value);

    const keyObj = await crypto.subtle.generateKey(
      { name: "AES-GCM", length: 256 },
      true,
      ["encrypt","decrypt"]
    );

    const iv = crypto.getRandomValues(new Uint8Array(12)); // nonce 12 bytes

    const ctAll = new Uint8Array(await crypto.subtle.encrypt(
      { name: "AES-GCM", iv },
      keyObj,
      plain
    ));

    const ciphertext = ctAll.slice(0, ctAll.length - 16);
    const tag = ctAll.slice(ctAll.length - 16);

    const rawKey = new Uint8Array(await crypto.subtle.exportKey("raw", keyObj));

    $("key").value = b64url(rawKey);
    $("token").value = `v1.${b64url(iv)}.${b64url(ciphertext)}.${b64url(tag)}`;
    $("out").value = "";
  }

  async function decrypt() {
    try {
      const keyB64 = $("key").value.trim();
      const token = $("token").value.trim();

      const parts = token.split(".");
      if (parts.length !== 4 || parts[0] !== "v1") throw new Error("TOKEN sai format.");

      const nonce = b64urlToU8(parts[1]);
      const ciphertext = b64urlToU8(parts[2]);
      const tag = b64urlToU8(parts[3]);

      const rawKey = b64urlToU8(keyB64);

      const keyObj = await crypto.subtle.importKey(
        "raw",
        rawKey,
        { name: "AES-GCM" },
        false,
        ["decrypt"]
      );

      const ctAll = new Uint8Array(ciphertext.length + tag.length);
      ctAll.set(ciphertext, 0);
      ctAll.set(tag, ciphertext.length);

      const pt = new Uint8Array(await crypto.subtle.decrypt(
        { name: "AES-GCM", iv: nonce },
        keyObj,
        ctAll
      ));

      $("out").value = new TextDecoder().decode(pt);
    } catch (e) {
      $("out").value = "Decrypt failed: " + e.message;
    }
  }

  $("btnEnc").addEventListener("click", encrypt);
  $("btnDec").addEventListener("click", decrypt);
</script>
</body>
</html>
