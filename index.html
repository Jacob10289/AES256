<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AES-256-GCM</title>
  <style>
    :root{
      --bg0:#05060a;
      --bg1:#070913;
      --bg2:#0b0e1e;
      --fg:#f5f5f7;
      --line:rgba(255,255,255,.11);
      --field:rgba(0,0,0,.28);
      --shadow:rgba(0,0,0,.74);
      --ring:rgba(210,230,255,.18);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;min-height:100vh;
      display:flex;align-items:center;justify-content:center;
      background:radial-gradient(1200px 800px at 50% 35%, var(--bg2), var(--bg0) 65%);
      color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      overflow:hidden;
    }

    .sky{
      position:fixed;inset:0;
      pointer-events:none;
      z-index:0;
      background:
        radial-gradient(900px 700px at 20% 20%, rgba(255,255,255,.05), transparent 55%),
        radial-gradient(900px 700px at 82% 28%, rgba(255,255,255,.035), transparent 58%),
        radial-gradient(1100px 800px at 50% 95%, rgba(255,255,255,.028), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      transform:translate3d(0,0,0);
    }

    .stars{
      position:fixed;inset:-10%;
      pointer-events:none;
      z-index:1;
      opacity:.55;
      background:
        radial-gradient(circle at 12% 18%, rgba(255,255,255,.9) 0 1px, transparent 2px),
        radial-gradient(circle at 24% 72%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 32% 28%, rgba(255,255,255,.8) 0 1px, transparent 2px),
        radial-gradient(circle at 41% 62%, rgba(255,255,255,.75) 0 1px, transparent 2px),
        radial-gradient(circle at 53% 18%, rgba(255,255,255,.85) 0 1px, transparent 2px),
        radial-gradient(circle at 61% 48%, rgba(255,255,255,.65) 0 1px, transparent 2px),
        radial-gradient(circle at 70% 78%, rgba(255,255,255,.78) 0 1px, transparent 2px),
        radial-gradient(circle at 80% 34%, rgba(255,255,255,.72) 0 1px, transparent 2px),
        radial-gradient(circle at 92% 60%, rgba(255,255,255,.8) 0 1px, transparent 2px),
        radial-gradient(circle at 18% 46%, rgba(255,255,255,.6) 0 1px, transparent 2px),
        radial-gradient(circle at 36% 86%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 58% 84%, rgba(255,255,255,.62) 0 1px, transparent 2px),
        radial-gradient(circle at 76% 12%, rgba(255,255,255,.7) 0 1px, transparent 2px),
        radial-gradient(circle at 6% 62%, rgba(255,255,255,.6) 0 1px, transparent 2px);
      filter:drop-shadow(0 0 10px rgba(255,255,255,.08));
      animation: drift 42s linear infinite;
    }
    @keyframes drift{
      0%{transform:translate3d(0,0,0)}
      100%{transform:translate3d(-3.8%, 2.6%, 0)}
    }

    .meteors{
      position:fixed;inset:0;
      pointer-events:none;
      z-index:2;
      overflow:hidden;
      opacity:.95;
    }
    .meteor{
      position:absolute;
      top:var(--top);
      left:var(--left);
      width:var(--len);
      height:2px;
      transform:rotate(var(--rot));
      background:linear-gradient(90deg, rgba(255,255,255,0), rgba(210,235,255,.95), rgba(255,255,255,.85));
      filter:drop-shadow(0 0 10px rgba(255,255,255,.12));
      opacity:0;
      animation: meteorFly var(--dur) linear infinite;
      animation-delay:var(--delay);
    }
    @keyframes meteorFly{
      0%{transform:translate3d(0,0,0) rotate(var(--rot)); opacity:0}
      6%{opacity:1}
      100%{transform:translate3d(var(--dx), var(--dy), 0) rotate(var(--rot)); opacity:0}
    }

    .grain{
      position:fixed;inset:0;
      pointer-events:none;
      z-index:2;
      opacity:.10;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='220' height='220'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='220' height='220' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
      mix-blend-mode:overlay;
    }
    .vignette{
      position:fixed;inset:0;
      pointer-events:none;
      z-index:2;
      background:radial-gradient(1100px 680px at 50% 45%, transparent 42%, rgba(0,0,0,.55) 78%, rgba(0,0,0,.80) 100%);
    }

    .box{
      position:relative;
      width:min(980px,92vw);
      padding:24px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:18px;
      background:
        radial-gradient(120% 180% at 10% 0%, rgba(255,255,255,.06), transparent 62%),
        radial-gradient(120% 180% at 90% 0%, rgba(255,255,255,.04), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.028));
      box-shadow:0 26px 70px rgba(0,0,0,.62);
      backdrop-filter: blur(12px);
      z-index:3;
      overflow:hidden;
    }
    .box::before{
      content:"";
      position:absolute;inset:-1px;
      border-radius:18px;
      padding:1px;
      background:linear-gradient(135deg, rgba(255,255,255,.16), rgba(255,255,255,.06), rgba(255,255,255,.10));
      -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
      -webkit-mask-composite:xor;
      mask-composite:exclude;
      pointer-events:none;
      opacity:.58;
    }
    .box::after{
      content:"";
      position:absolute;inset:-35% -25%;
      background:
        radial-gradient(520px 420px at 30% 25%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(520px 420px at 75% 35%, rgba(255,255,255,.045), transparent 62%),
        radial-gradient(520px 520px at 55% 88%, rgba(255,255,255,.04), transparent 65%);
      filter:blur(34px);
      opacity:.55;
      animation: panelGlow 10s ease-in-out infinite alternate;
      pointer-events:none;
    }
    @keyframes panelGlow{
      0%{transform:translate(-1.2%,-.8%) scale(1.00)}
      100%{transform:translate(1.0%,1.2%) scale(1.03)}
    }

    .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
      flex-wrap:nowrap;
      position:relative;
      z-index:2;
    }
    h1{
      margin:0;
      font-size:16px;
      letter-spacing:.2px;
      opacity:.96;
      flex:1 1 auto;
      min-width:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      text-shadow:0 0 18px rgba(255,255,255,.10);
    }
    .right{
      flex:0 0 auto;
      max-width:100%;
      margin-left:auto;
      display:flex;
      justify-content:flex-end;
    }
    .pillbtn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(120% 200% at 30% 0%, rgba(255,255,255,.07), transparent 60%),
        radial-gradient(120% 200% at 85% 0%, rgba(255,255,255,.045), transparent 60%),
        rgba(0,0,0,.22);
      color:rgba(245,245,247,.92);
      font-size:12px;
      cursor:pointer;
      white-space:nowrap;
      max-width:100%;
      transition:transform .14s ease, border-color .18s ease, box-shadow .18s ease, filter .18s ease;
      box-shadow:0 14px 28px rgba(0,0,0,.42);
      position:relative;
      overflow:hidden;
    }
    .pillbtn::after{
      content:"";
      position:absolute;inset:-2px;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      transform:translateX(-120%);
      transition:transform .55s ease;
      pointer-events:none;
    }
    .pillbtn:hover{border-color:var(--ring);filter:brightness(1.06)}
    .pillbtn:hover::after{transform:translateX(120%)}
    .pillbtn:active{transform:translateY(1px) scale(.99)}
    .pillbtn:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(220,235,255,.14), 0 14px 28px rgba(0,0,0,.42)}

    .row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0;position:relative;z-index:2}
    .two{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      width:100%;
    }
    .two > button{width:100%}

    input,textarea,button{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.11);
      background:
        radial-gradient(140% 220% at 20% 0%, rgba(255,255,255,.06), transparent 60%),
        radial-gradient(140% 220% at 90% 0%, rgba(255,255,255,.035), transparent 62%),
        rgba(0,0,0,.24);
      color:var(--fg);
      padding:12px 14px;
      font-size:14px;
      outline:none;
      transition:border-color .16s ease, box-shadow .16s ease, transform .14s ease, filter .16s ease;
    }
    input::placeholder, textarea::placeholder{color:rgba(245,245,247,.55)}
    input,textarea{flex:1;min-width:240px}
    textarea{width:100%;min-height:140px;resize:vertical;line-height:1.35}
    input:focus,textarea:focus{
      border-color:var(--ring);
      box-shadow:0 0 0 3px rgba(220,235,255,.11);
      filter:brightness(1.05);
    }

    button{
      cursor:pointer;
      user-select:none;
      letter-spacing:.25px;
      font-weight:750;
      background:
        linear-gradient(135deg, rgba(255,255,255,.08), rgba(255,255,255,.03), rgba(0,0,0,.10)),
        radial-gradient(180% 260% at 22% 0%, rgba(255,255,255,.07), transparent 62%),
        radial-gradient(180% 260% at 90% 0%, rgba(255,255,255,.04), transparent 64%),
        rgba(0,0,0,.22);
      box-shadow:0 16px 34px rgba(0,0,0,.48);
      position:relative;
      overflow:hidden;
    }
    button::after{
      content:"";
      position:absolute;inset:-2px;
      background:linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      transform:translateX(-120%);
      transition:transform .55s ease;
      pointer-events:none;
    }
    button:hover{border-color:var(--ring);filter:brightness(1.06)}
    button:hover::after{transform:translateX(120%)}
    button:active{transform:translateY(1px) scale(.99)}
    button:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(220,235,255,.14), 0 16px 34px rgba(0,0,0,.48)}

    .mini{flex:0;min-width:190px}
    .pwwrap{display:flex;gap:10px;flex:1;min-width:260px}
    .pwwrap input{flex:1;min-width:0}
    .pwbtn{flex:0;min-width:120px}

    .toast{
      position:fixed;left:50%;bottom:28px;transform:translateX(-50%);
      background:
        radial-gradient(140% 240% at 22% 0%, rgba(255,255,255,.08), transparent 60%),
        radial-gradient(140% 240% at 90% 0%, rgba(255,255,255,.05), transparent 60%),
        rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.16);
      padding:10px 14px;border-radius:12px;
      font-size:13px;opacity:0;pointer-events:none;
      transition:opacity .18s ease, transform .18s ease, filter .18s ease;
      box-shadow:0 12px 26px var(--shadow);
      z-index:4;
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-2px);filter:brightness(1.04)}

    .disabled{
      opacity:.45;
      pointer-events:none;
      filter:saturate(.70) brightness(.95);
    }

    @media (max-width: 420px){
      input,textarea{min-width:0}
      .mini{min-width:0;flex:1}
      .pwbtn{min-width:110px}
      .pwwrap{min-width:0}
      .box{padding:20px}
    }

    @media (prefers-reduced-motion: reduce){
      .stars,.meteors,.box::after{animation:none}
      .meteor{animation:none}
      *{transition:none !important}
    }
  </style>
</head>
<body>
  <div class="sky"></div>
  <div class="stars" aria-hidden="true"></div>

  <div class="meteors" aria-hidden="true">
    <span class="meteor" style="--top:6%;--left:-22%;--len:360px;--rot:22deg;--dx:170vw;--dy:78vh;--dur:1.9s;--delay:0.2s"></span>
    <span class="meteor" style="--top:10%;--left:-35%;--len:280px;--rot:20deg;--dx:165vw;--dy:74vh;--dur:2.1s;--delay:0.9s"></span>
    <span class="meteor" style="--top:14%;--left:-18%;--len:420px;--rot:23deg;--dx:175vw;--dy:82vh;--dur:1.8s;--delay:1.6s"></span>
    <span class="meteor" style="--top:18%;--left:-42%;--len:320px;--rot:19deg;--dx:168vw;--dy:76vh;--dur:2.2s;--delay:2.2s"></span>
    <span class="meteor" style="--top:22%;--left:-28%;--len:380px;--rot:21deg;--dx:172vw;--dy:80vh;--dur:2.0s;--delay:3.0s"></span>
    <span class="meteor" style="--top:26%;--left:-38%;--len:260px;--rot:18deg;--dx:160vw;--dy:70vh;--dur:2.3s;--delay:3.6s"></span>
    <span class="meteor" style="--top:30%;--left:-20%;--len:460px;--rot:24deg;--dx:178vw;--dy:86vh;--dur:1.7s;--delay:4.3s"></span>
    <span class="meteor" style="--top:34%;--left:-45%;--len:340px;--rot:20deg;--dx:170vw;--dy:78vh;--dur:2.1s;--delay:5.0s"></span>
    <span class="meteor" style="--top:38%;--left:-26%;--len:400px;--rot:22deg;--dx:174vw;--dy:82vh;--dur:1.9s;--delay:5.6s"></span>
    <span class="meteor" style="--top:42%;--left:-40%;--len:300px;--rot:19deg;--dx:166vw;--dy:74vh;--dur:2.2s;--delay:6.2s"></span>
    <span class="meteor" style="--top:46%;--left:-18%;--len:440px;--rot:23deg;--dx:176vw;--dy:84vh;--dur:1.8s;--delay:6.9s"></span>
    <span class="meteor" style="--top:50%;--left:-36%;--len:280px;--rot:18deg;--dx:162vw;--dy:70vh;--dur:2.3s;--delay:7.4s"></span>
    <span class="meteor" style="--top:12%;--left:-55%;--len:360px;--rot:21deg;--dx:180vw;--dy:88vh;--dur:2.0s;--delay:8.1s"></span>
    <span class="meteor" style="--top:28%;--left:-60%;--len:320px;--rot:20deg;--dx:178vw;--dy:86vh;--dur:2.2s;--delay:8.7s"></span>
    <span class="meteor" style="--top:44%;--left:-58%;--len:420px;--rot:23deg;--dx:184vw;--dy:92vh;--dur:1.8s;--delay:9.2s"></span>
    <span class="meteor" style="--top:60%;--left:-52%;--len:300px;--rot:19deg;--dx:176vw;--dy:84vh;--dur:2.3s;--delay:9.8s"></span>
  </div>

  <div class="grain" aria-hidden="true"></div>
  <div class="vignette" aria-hidden="true"></div>

  <div class="box">
    <div class="top">
      <h1>AES-256-GCM</h1>
      <div class="right">
        <button id="btnSafe" class="pillbtn">BẢO MẬT : TẮT</button>
      </div>
    </div>

    <div class="row">
      <input id="plain" placeholder="Văn bản gốc" value="" autocomplete="off" />
      <input id="iters" class="mini" type="number" value="100000" min="100000" step="100000" inputmode="numeric" />
    </div>

    <div class="row">
      <div class="pwwrap">
        <input id="pass" type="password" placeholder="Mật khẩu" autocomplete="new-password" />
        <button id="btnTogglePass" class="pwbtn">HIỆN</button>
      </div>
    </div>

    <div class="row two">
      <button id="btnEnc">MÃ HOÁ</button>
      <button id="btnDec">GIẢI MÃ</button>
    </div>

    <div class="row">
      <textarea id="token" spellcheck="false" placeholder="Token mã hoá"></textarea>
    </div>

    <div class="row two">
      <button id="btnCopy">SAO CHÉP</button>
      <button id="btnClear">XOÁ</button>
    </div>

    <div class="row">
      <input id="out" placeholder="Kết quả" autocomplete="off" />
    </div>
  </div>

  <div id="toast" class="toast">OK</div>

<script>
  const $ = (id) => document.getElementById(id);

  const enc = new TextEncoder();
  const dec = new TextDecoder();

  const b64url = (u8) =>
    btoa(String.fromCharCode(...u8))
      .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');

  const b64urlToU8 = (s) => {
    s = s.replace(/-/g,'+').replace(/_/g,'/');
    s += '='.repeat((4 - (s.length % 4)) % 4);
    const bin = atob(s);
    const u8 = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) u8[i] = bin.charCodeAt(i);
    return u8;
  };

  const getIters = () => {
    const n = parseInt($("iters").value || "100000", 10);
    return Number.isFinite(n) ? Math.max(100000, n) : 100000;
  };

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 900);
  }

  let SAFE_MODE = false;

  const disableInSafeMode = [
    "plain",
    "btnTogglePass",
    "out"
  ];

  function setDisabled(id, on){
    const el = $(id);
    if (!el) return;
    el.disabled = !!on;
    if (on) el.classList.add("disabled");
    else el.classList.remove("disabled");
  }

  function applySafeMode(){
    $("btnSafe").textContent = `BẢO MẬT : ${SAFE_MODE ? "BẬT" : "TẮT"}`;

    if (SAFE_MODE) {
      $("plain").value = "";
      $("out").value = "";
      $("pass").value = "";

      $("pass").type = "password";
      $("btnTogglePass").textContent = "HIỆN";

      disableInSafeMode.forEach(id => setDisabled(id, true));

      $("plain").placeholder = "Văn bản gốc";
      $("out").placeholder = "Kết quả";

      toast("Đã bật bảo mật");
    } else {
      disableInSafeMode.forEach(id => setDisabled(id, false));
      $("plain").placeholder = "Văn bản gốc";
      $("out").placeholder = "Kết quả";
      toast("Đã tắt bảo mật");
    }
  }

  async function deriveAesKeyFromPass(pass, saltU8, iters) {
    const passKey = await crypto.subtle.importKey(
      "raw",
      enc.encode(pass),
      { name: "PBKDF2" },
      false,
      ["deriveKey"]
    );

    return crypto.subtle.deriveKey(
      { name: "PBKDF2", salt: saltU8, iterations: iters, hash: "SHA-256" },
      passKey,
      { name: "AES-GCM", length: 256 },
      false,
      ["encrypt", "decrypt"]
    );
  }

  function getPlaintextForEncrypt(){
    if (!SAFE_MODE) return $("plain").value;
    const v = prompt("Nhập văn bản gốc để mã hoá:", "");
    return (v ?? "").trim();
  }

  function setOutputAfterDecrypt(text){
    if (SAFE_MODE) {
      $("out").value = "";
      alert(text);
    } else {
      $("out").value = text;
    }
  }

  function clearSensitive(){
    $("pass").value = "";
    if (SAFE_MODE) $("plain").value = "";
  }

  async function encrypt() {
    try {
      const plain = getPlaintextForEncrypt();
      const pass = $("pass").value;

      if (!plain) throw new Error("Bạn chưa nhập văn bản gốc.");
      if (!pass || pass.length < 10) throw new Error("Mật khẩu quá yếu.");

      const iters = getIters();
      const salt = crypto.getRandomValues(new Uint8Array(16));
      const nonce = crypto.getRandomValues(new Uint8Array(12));

      const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

      const ctAll = new Uint8Array(await crypto.subtle.encrypt(
        { name: "AES-GCM", iv: nonce },
        aesKey,
        enc.encode(plain)
      ));

      const ciphertext = ctAll.slice(0, ctAll.length - 16);
      const tag = ctAll.slice(ctAll.length - 16);

      $("token").value = `v3.${iters}.${b64url(salt)}.${b64url(nonce)}.${b64url(ciphertext)}.${b64url(tag)}`;

      clearSensitive();
      toast("Đã mã hoá");
    } catch (e) {
      toast("Có lỗi");
      if (!SAFE_MODE) $("out").value = "Mã hoá thất bại: " + (e?.message || e);
    }
  }

  async function decrypt() {
    try {
      const pass = $("pass").value.trim();
      const token = $("token").value.trim();

      if (!pass) throw new Error("Bạn chưa nhập mật khẩu.");
      if (!token) throw new Error("Bạn chưa dán token.");

      const parts = token.split(".");
      if (parts.length !== 6 || parts[0] !== "v3") throw new Error("Token không đúng định dạng.");

      const iters = parseInt(parts[1], 10);
      if (!Number.isFinite(iters) || iters < 100000) throw new Error("Iterations trong token không hợp lệ.");

      const salt = b64urlToU8(parts[2]);
      const nonce = b64urlToU8(parts[3]);
      const ciphertext = b64urlToU8(parts[4]);
      const tag = b64urlToU8(parts[5]);

      const aesKey = await deriveAesKeyFromPass(pass, salt, iters);

      const ctAll = new Uint8Array(ciphertext.length + tag.length);
      ctAll.set(ciphertext, 0);
      ctAll.set(tag, ciphertext.length);

      const pt = new Uint8Array(await crypto.subtle.decrypt(
        { name: "AES-GCM", iv: nonce },
        aesKey,
        ctAll
      ));

      const text = dec.decode(pt);
      setOutputAfterDecrypt(text);
      clearSensitive();
      toast("Đã giải mã");
    } catch (e) {
      toast("Có lỗi");
      if (!SAFE_MODE) $("out").value = "Giải mã thất bại: " + (e?.message || e);
    }
  }

  async function copyToken(){
    const token = $("token").value.trim();
    if (!token) return toast("Chưa có token");
    try{
      await navigator.clipboard.writeText(token);
      toast("Đã sao chép");
    }catch{
      $("token").focus();
      $("token").select();
      document.execCommand("copy");
      toast("Đã sao chép");
    }
  }

  function clearAll(){
    if (SAFE_MODE) $("plain").value = "";
    $("pass").value = "";
    $("token").value = "";
    $("out").value = "";
    toast("Đã xoá");
  }

  function togglePass(){
    if (SAFE_MODE) return;
    const p = $("pass");
    const isPw = p.type === "password";
    p.type = isPw ? "text" : "password";
    $("btnTogglePass").textContent = isPw ? "ẨN" : "HIỆN";
  }

  $("btnEnc").addEventListener("click", encrypt);
  $("btnDec").addEventListener("click", decrypt);
  $("btnCopy").addEventListener("click", copyToken);
  $("btnClear").addEventListener("click", clearAll);
  $("btnTogglePass").addEventListener("click", togglePass);

  $("btnSafe").addEventListener("click", () => {
    SAFE_MODE = !SAFE_MODE;
    applySafeMode();
  });

  applySafeMode();
</script>
</body>
</html>
